CREATE DEFINER=`root`@`localhost` PROCEDURE `GET_USERS_PAGED`(

	IN page INT,

    IN pageSize INT,

    IN searchText VARCHAR(255),

    IN status VARCHAR(255),

    IN Date VARCHAR(255)

)
BEGIN

    DECLARE totalCount INT;

    DECLARE offset INT;

    SET page = IFNULL(page, 1);

    SET pageSize = IFNULL(pageSize, 10);

    SET searchText = IFNULL(searchText, '');

    SET offset = (page - 1) * pageSize;

	SET totalCount =  (SELECT COUNT(*) FROM wp_users) ; -- Default to 0 if NULL

   -- Select the filtered and grouped user data with total posts and role extraction

    SELECT 

        u.Id,

        u.user_login,

        u.display_name,

        u.user_email,

        u.user_nicename,

        u.user_status,

        u.user_url,

         u.user_registered,

        COUNT(p.Id) AS Total_Posts,

        CASE 

            WHEN um.Meta_Value IS NOT NULL THEN

                -- Assuming role is part of the MetaValue stored like: "s:6:\"editor\";b:1;"

                SUBSTRING_INDEX(SUBSTRING_INDEX(um.Meta_Value, ':"', -1), '"', 1)

            ELSE ''

        END AS Role,

        CASE 

            WHEN ua.Meta_Value IS NOT NULL THEN ua.Meta_Value

            ELSE 'https://secure.gravatar.com/avatar/5f40d96b53f99022e02458fd88d3b8a2?s=96&d=mm&r=g'  -- You can replace 'default_avatar_url' with a default image URL

        END AS Avatar,

		totalCount AS TotalCount,

        CEIL(totalCount / pageSize) AS totalpages,

        page AS page,

        pageSize AS pagesize,

        1 AS indexfrom

    FROM wp_users u

    LEFT JOIN wp_posts p ON u.Id = p.Post_Author and p.post_type = 'post'

    LEFT JOIN wp_usermeta um ON u.Id = um.User_Id AND um.Meta_Key = 'wp_capabilities'

    LEFT JOIN wp_usermeta ua ON u.Id = ua.User_Id AND ua.Meta_Key = 'wp_user_avatar'  -- Avatar metadata

    WHERE (LOWER(u.user_login) LIKE CONCAT('%', LOWER(searchText), '%') COLLATE utf8mb4_unicode_ci 

        OR LOWER(u.user_email) LIKE CONCAT('%', LOWER(searchText), '%') COLLATE utf8mb4_unicode_ci  

        OR LOWER(u.display_name) LIKE CONCAT('%', LOWER(searchText), '%') COLLATE utf8mb4_unicode_ci 

        OR LOWER(um.Meta_Value) LIKE CONCAT('%', LOWER(searchText), '%') COLLATE utf8mb4_unicode_ci )

        AND (

			status = '' OR u.user_status = status COLLATE utf8mb4_unicode_ci

		)

        AND  

		(	CASE  WHEN (Date IS NULL or Date = '') THEN true

				ELSE (YEAR(u.user_registered) = YEAR(Date) AND MONTH(u.user_registered) = MONTH(Date))

			END 

        )

     GROUP BY u.Id, um.Meta_Value, ua.Meta_Value

    ORDER BY u.Id

    LIMIT offset, pageSize;
 
END